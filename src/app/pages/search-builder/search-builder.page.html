<app-header></app-header>

<ion-content class="ion-padding">
  <ion-grid>
    <ion-row>
      <!-- Builder Column -->
      <ion-col size="12" size-lg="6">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Search Builder</ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <form [formGroup]="form">
              <!-- Search Type Segment -->
              <ion-segment
                [value]="form.get('searchType')?.value"
                (ionChange)="onSearchTypeChange($event)"
                class="search-type-segment">
                @for (type of searchTypes; track type.value) {
                  <ion-segment-button [value]="type.value">
                    <ion-icon [name]="type.icon"></ion-icon>
                    <ion-label>{{ type.label }}</ion-label>
                  </ion-segment-button>
                }
              </ion-segment>

              <!-- Platform Selector -->
              @if (availablePlatforms.length === 0) {
                <ion-item color="warning">
                  <ion-icon name="warning-outline" slot="start"></ion-icon>
                  <ion-label class="ion-text-wrap">
                    No platforms available. Enable at least one platform in feature flags.
                  </ion-label>
                </ion-item>
              } @else {
                <ion-item class="platform-select">
                  <ion-select
                    label="Platform"
                    labelPlacement="floating"
                    [value]="currentPlatformId"
                    (ionChange)="onPlatformChange($event.detail.value)"
                    interface="popover">
                    @for (platform of availablePlatforms; track platform.id) {
                      <ion-select-option [value]="platform.id">
                        {{ platform.label }}
                      </ion-select-option>
                    }
                  </ion-select>
                </ion-item>
              }

              <!-- Platform Notes -->
              <ion-text color="medium" class="platform-notes">
                <small>{{ platformRegistry.currentPlatform().notes[0] }}</small>
              </ion-text>

              <!-- Emotional Search Mode Selector (not for posts) -->
              @if (!showPostsBuilder) {
                <div class="emotional-mode-selector">
                  <ion-label class="emotional-mode-label">Search Mode</ion-label>
                  <ion-segment formControlName="emotionalMode" class="emotional-mode-segment">
                    <ion-segment-button value="urgent">
                      <ion-label>{{ emotionalModeConfig.urgent.icon }} Urgent</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="normal">
                      <ion-label>{{ emotionalModeConfig.normal.icon }} Normal</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="chill">
                      <ion-label>{{ emotionalModeConfig.chill.icon }} Chill</ion-label>
                    </ion-segment-button>
                  </ion-segment>
                  <ion-text color="medium" class="emotional-mode-description">
                    <small>{{ currentEmotionalModeDescription }}</small>
                  </ion-text>
                </div>

                <!-- Emotional Mode Adjustments (shown when active) -->
                @if (emotionalAdjustments.length > 0) {
                  <div class="emotional-adjustments">
                    <ion-text color="medium">
                      <small>
                        <strong>Adjustments:</strong>
                        @for (adj of emotionalAdjustments; track adj) {
                          <span class="adjustment-item">{{ adj }}</span>
                        }
                      </small>
                    </ion-text>
                  </div>
                }
              }

              <!-- Boolean Level Warning for Limited Platforms -->
              @if (hasLimitedBoolean) {
                <div class="capability-hint">
                  <ion-icon name="information-circle-outline" color="warning"></ion-icon>
                  <ion-text color="warning">
                    <small>
                      @if (currentBooleanLevel === 'partial') {
                        Limited Boolean support. Complex queries will be simplified.
                      } @else {
                        Keywords only. Boolean operators are not supported.
                      }
                    </small>
                  </ion-text>
                </div>
              }

              <!-- Google Jobs-specific toggles -->
              @if (isGoogleJobsPlatform) {
                <ion-item class="platform-option">
                  <ion-label>Include location in query</ion-label>
                  <ion-toggle
                    slot="end"
                    [checked]="googleJobsAdapter.includeLocationKeyword()"
                    (ionChange)="onGoogleJobsLocationToggleChange($event.detail.checked)">
                  </ion-toggle>
                </ion-item>

                <ion-item class="platform-option">
                  <ion-select
                    label="Skills joiner"
                    labelPlacement="floating"
                    [value]="googleJobsAdapter.skillsJoiner()"
                    (ionChange)="onGoogleJobsSkillsJoinerChange($event.detail.value)"
                    interface="popover">
                    <ion-select-option value="OR">OR (broader results)</ion-select-option>
                    <ion-select-option value="AND">AND (more specific)</ion-select-option>
                  </ion-select>
                </ion-item>

                <!-- Location input for Google Jobs -->
                <ion-item class="platform-option">
                  <ion-input
                    label="Location"
                    labelPlacement="floating"
                    formControlName="location"
                    placeholder="e.g., San Francisco, CA">
                  </ion-input>
                </ion-item>

                <ion-text color="medium" class="platform-hint">
                  <small>Google Jobs works best with shorter, simpler queries.</small>
                </ion-text>
              }

              <!-- Indeed-specific: Region selector -->
              @if (isIndeedPlatform) {
                <ion-item class="platform-option">
                  <ion-select
                    label="Region"
                    labelPlacement="floating"
                    [value]="indeedAdapter.currentRegion()"
                    (ionChange)="onIndeedRegionChange($event.detail.value)"
                    interface="popover">
                    @for (region of indeedRegions; track region.value) {
                      <ion-select-option [value]="region.value">
                        {{ region.label }}
                      </ion-select-option>
                    }
                  </ion-select>
                </ion-item>
              }

              <!-- Main Builder Section (People/Jobs) -->
              @if (showMainBuilder) {
                <!-- Titles Input (OR joined) -->
                <app-chip-input
                  formControlName="titles"
                  label="Job Titles (OR)"
                  placeholder="e.g., Software Engineer"
                  chipColor="primary"
                  helperText="Multiple titles are joined with OR">
                </app-chip-input>

                <!-- Skills Input (AND joined) -->
                <app-chip-input
                  formControlName="skills"
                  label="Skills (AND)"
                  placeholder="e.g., Angular, TypeScript"
                  chipColor="secondary"
                  helperText="Skills are joined with AND">
                </app-chip-input>

                <!-- Exclude Input (NOT) -->
                <app-chip-input
                  formControlName="exclude"
                  label="Exclude (NOT)"
                  placeholder="e.g., Junior, Intern"
                  chipColor="danger"
                  helperText="Terms to exclude from results">
                </app-chip-input>
              }

              <!-- Posts Builder Section -->
              @if (showPostsBuilder) {
                <ion-text color="medium" class="posts-helper-text">
                  <small>We'll generate a search link to find posts that match your intent.</small>
                </ion-text>

                <!-- Posts Keywords Input -->
                <app-chip-input
                  formControlName="postsKeywords"
                  label="Keywords"
                  placeholder="e.g., Angular, Frontend Engineer"
                  chipColor="primary"
                  helperText="Primary search terms">
                </app-chip-input>

                <!-- Any Of Phrases (OR) -->
                <app-chip-input
                  formControlName="postsAnyOfPhrases"
                  label="Any of these (OR)"
                  placeholder="e.g., developer, engineer"
                  chipColor="secondary"
                  helperText="Posts containing any of these phrases">
                </app-chip-input>

                <!-- Must Include Phrases -->
                <app-chip-input
                  formControlName="postsMustIncludePhrases"
                  label="Must include"
                  placeholder="e.g., remote, senior"
                  chipColor="tertiary"
                  helperText="Exact phrases that must appear">
                </app-chip-input>

                <!-- Exclude Phrases -->
                <app-chip-input
                  formControlName="postsExcludePhrases"
                  label="Exclude"
                  placeholder="e.g., intern, unpaid"
                  chipColor="danger"
                  helperText="Terms to exclude from results">
                </app-chip-input>

                <!-- Hashtags (for platforms that support it) -->
                <app-chip-input
                  formControlName="postsHashtags"
                  label="Hashtags"
                  placeholder="e.g., hiring, opentowork"
                  chipColor="success"
                  helperText="Hashtags to search for (without #)">
                </app-chip-input>

                <!-- Location -->
                <ion-item class="location-item">
                  <ion-input
                    label="Location"
                    labelPlacement="floating"
                    formControlName="postsLocationText"
                    placeholder="e.g., Germany, Remote, San Francisco"
                    [clearInput]="true">
                  </ion-input>
                </ion-item>

                <!-- Date Range -->
                <ion-item class="filter-item">
                  <ion-select
                    label="Date Range"
                    labelPlacement="floating"
                    formControlName="postsDateRange"
                    interface="popover">
                    @for (option of postsDateRangeOptions; track option.value) {
                      <ion-select-option [value]="option.value">
                        {{ option.label }}
                      </ion-select-option>
                    }
                  </ion-select>
                </ion-item>

                <!-- Intent Toggles -->
                <div class="intent-toggles">
                  <ion-item class="intent-toggle-item">
                    <ion-label>
                      <h3>Hiring Intent</h3>
                      <p>Add phrases like "hiring", "job opening", "we're hiring"</p>
                    </ion-label>
                    <ion-toggle slot="end" formControlName="includeHiringIntent"></ion-toggle>
                  </ion-item>

                  <ion-item class="intent-toggle-item">
                    <ion-label>
                      <h3>Open to Work Intent</h3>
                      <p>Add phrases like "open to work", "seeking opportunities"</p>
                    </ion-label>
                    <ion-toggle slot="end" formControlName="includeOpenToWorkIntent"></ion-toggle>
                  </ion-item>

                  <ion-item class="intent-toggle-item">
                    <ion-label>
                      <h3>Remote Intent</h3>
                      <p>Add phrases like "remote", "work from home", "anywhere"</p>
                    </ion-label>
                    <ion-toggle slot="end" formControlName="includeRemoteIntent"></ion-toggle>
                  </ion-item>
                </div>
              }

              <!-- People Location (People search only) -->
              @if (showPeopleLocation) {
                <ion-item class="location-item">
                  <ion-input
                    label="Location"
                    labelPlacement="floating"
                    formControlName="peopleLocation"
                    placeholder="e.g., Germany, Berlin, Cairo"
                    [clearInput]="true">
                  </ion-input>
                </ion-item>
                <ion-text color="medium" class="filter-helper">
                  <small>Adds location keywords to narrow your people search.</small>
                </ion-text>
              }

              <!-- Job Filters (for Jobs + LinkedIn platforms only) -->
              @if (isJobsSearch && showLinkedInFilters) {
                <ion-accordion-group [value]="defaultAccordionValue">
                  <ion-accordion value="filters">
                    <ion-item slot="header" color="light">
                      <ion-label>Job Filters</ion-label>
                    </ion-item>
                    <div class="accordion-content" slot="content">
                      <ion-text color="medium" class="filter-helper">
                        <small>These filters apply to LinkedIn search URL parameters.</small>
                      </ion-text>

                      <!-- Location -->
                      <ion-item class="filter-item">
                        <ion-input
                          label="Location"
                          labelPlacement="floating"
                          formControlName="location"
                          placeholder="e.g., San Francisco, CA">
                        </ion-input>
                      </ion-item>

                      <!-- Sort By -->
                      <ion-item class="filter-item">
                        <ion-select
                          label="Sort By"
                          labelPlacement="floating"
                          formControlName="sortBy"
                          interface="popover">
                          @for (option of sortByOptions; track option.value) {
                            <ion-select-option [value]="option.value">
                              {{ option.label }}
                            </ion-select-option>
                          }
                        </ion-select>
                      </ion-item>

                      <!-- Date Posted -->
                      <ion-item class="filter-item">
                        <ion-select
                          label="Date Posted"
                          labelPlacement="floating"
                          formControlName="datePosted"
                          interface="popover">
                          @for (option of datePostedOptions; track option.value) {
                            <ion-select-option [value]="option.value">
                              {{ option.label }}
                            </ion-select-option>
                          }
                        </ion-select>
                      </ion-item>

                      <!-- Job Type (Multi-select) -->
                      <ion-item class="filter-item">
                        <ion-select
                          label="Job Type"
                          labelPlacement="floating"
                          formControlName="jobTypes"
                          [multiple]="true"
                          interface="popover">
                          @for (option of jobTypeOptions; track option.value) {
                            <ion-select-option [value]="option.value">
                              {{ option.label }}
                            </ion-select-option>
                          }
                        </ion-select>
                      </ion-item>

                      <!-- Experience Level (Multi-select) -->
                      <ion-item class="filter-item">
                        <ion-select
                          label="Experience Level"
                          labelPlacement="floating"
                          formControlName="experienceLevels"
                          [multiple]="true"
                          interface="popover">
                          @for (option of experienceLevelOptions; track option.value) {
                            <ion-select-option [value]="option.value">
                              {{ option.label }}
                            </ion-select-option>
                          }
                        </ion-select>
                      </ion-item>

                      <!-- Work Type (Multi-select) -->
                      <ion-item class="filter-item">
                        <ion-select
                          label="Work Type"
                          labelPlacement="floating"
                          formControlName="workTypes"
                          [multiple]="true"
                          interface="popover">
                          @for (option of workTypeOptions; track option.value) {
                            <ion-select-option [value]="option.value">
                              {{ option.label }}
                            </ion-select-option>
                          }
                        </ion-select>
                      </ion-item>

                      <!-- Easy Apply Toggle -->
                      <ion-item class="filter-item">
                        <ion-label>Easy Apply only</ion-label>
                        <ion-toggle slot="end" formControlName="easyApply"></ion-toggle>
                      </ion-item>

                      <!-- Has Verifications Toggle -->
                      <ion-item class="filter-item">
                        <ion-label>Has verifications</ion-label>
                        <ion-toggle slot="end" formControlName="hasVerifications"></ion-toggle>
                      </ion-item>

                      <!-- Under 10 Applicants Toggle -->
                      <ion-item class="filter-item">
                        <ion-label>Under 10 applicants</ion-label>
                        <ion-toggle slot="end" formControlName="underTenApplicants"></ion-toggle>
                      </ion-item>

                      <!-- In Your Network Toggle -->
                      <ion-item class="filter-item">
                        <ion-label>
                          <h3>In your network</h3>
                          <p>Jobs from your connections</p>
                        </ion-label>
                        <ion-toggle slot="end" formControlName="inYourNetwork"></ion-toggle>
                      </ion-item>

                      <!-- Fair Chance Employer Toggle -->
                      <ion-item class="filter-item">
                        <ion-label>
                          <h3>Fair Chance Employer</h3>
                          <p>Employers committed to fair-chance hiring</p>
                        </ion-label>
                        <ion-toggle slot="end" formControlName="fairChanceEmployer"></ion-toggle>
                      </ion-item>
                    </div>
                  </ion-accordion>
                </ion-accordion-group>
              }

              <!-- People Filters (for People + LinkedIn platforms only) -->
              @if (!isJobsSearch && showLinkedInFilters) {
                <ion-accordion-group [value]="defaultAccordionValue">
                  <ion-accordion value="filters">
                    <ion-item slot="header" color="light">
                      <ion-label>People Filters</ion-label>
                    </ion-item>
                    <div class="accordion-content" slot="content">
                      <ion-text color="medium" class="filter-helper">
                        <small>These filters apply to LinkedIn search URL parameters.</small>
                      </ion-text>

                      <!-- Connection Level (Multi-select) -->
                      <ion-item class="filter-item">
                        <ion-select
                          label="Connection Level"
                          labelPlacement="floating"
                          formControlName="connectionLevels"
                          [multiple]="true"
                          interface="popover">
                          @for (option of connectionLevelOptions; track option.value) {
                            <ion-select-option [value]="option.value">
                              {{ option.label }}
                            </ion-select-option>
                          }
                        </ion-select>
                      </ion-item>

                      <!-- Profile Language (Multi-select) -->
                      <ion-item class="filter-item">
                        <ion-select
                          label="Profile Language"
                          labelPlacement="floating"
                          formControlName="profileLanguages"
                          [multiple]="true"
                          interface="popover">
                          @for (option of profileLanguageOptions; track option.value) {
                            <ion-select-option [value]="option.value">
                              {{ option.label }}
                            </ion-select-option>
                          }
                        </ion-select>
                      </ion-item>

                      <!-- First Name -->
                      <ion-item class="filter-item">
                        <ion-input
                          label="First Name"
                          labelPlacement="floating"
                          formControlName="firstName"
                          placeholder="e.g., John">
                        </ion-input>
                      </ion-item>

                      <!-- Last Name -->
                      <ion-item class="filter-item">
                        <ion-input
                          label="Last Name"
                          labelPlacement="floating"
                          formControlName="lastName"
                          placeholder="e.g., Smith">
                        </ion-input>
                      </ion-item>

                      <!-- Title -->
                      <ion-item class="filter-item">
                        <ion-input
                          label="Title"
                          labelPlacement="floating"
                          formControlName="keywordTitle"
                          placeholder="e.g., Software Engineer">
                        </ion-input>
                      </ion-item>

                      <!-- Company -->
                      <ion-item class="filter-item">
                        <ion-input
                          label="Company"
                          labelPlacement="floating"
                          formControlName="keywordCompany"
                          placeholder="e.g., Google">
                        </ion-input>
                      </ion-item>

                      <!-- School -->
                      <ion-item class="filter-item">
                        <ion-input
                          label="School"
                          labelPlacement="floating"
                          formControlName="keywordSchool"
                          placeholder="e.g., Stanford University">
                        </ion-input>
                      </ion-item>
                    </div>
                  </ion-accordion>
                </ion-accordion-group>
              }

              <!-- Hiring Signals (People + LinkedIn/SalesNav only) -->
              @if (showHiringSignals) {
                <ion-accordion-group>
                  <ion-accordion value="hiring-signals">
                    <ion-item slot="header" color="light">
                      <ion-label>
                        Hiring Signals
                        <ion-text color="medium"><small> (Recruiters)</small></ion-text>
                      </ion-label>
                      <ion-toggle
                        slot="end"
                        formControlName="hiringSignalsEnabled"
                        (ionChange)="onHiringSignalsToggle($event.detail.checked)">
                      </ion-toggle>
                    </ion-item>

                    <div class="accordion-content" slot="content">
                      <ion-text color="medium" class="filter-helper">
                        <small>Add profile text patterns to find available candidates.</small>
                      </ion-text>

                      @if (form.get('hiringSignalsEnabled')?.value) {
                        @for (signal of hiringSignalsCatalog; track signal.id) {
                          <ion-item class="signal-item">
                            <ion-checkbox
                              slot="start"
                              [checked]="form.get('hiringSignalsSelected')?.value?.includes(signal.id)"
                              (ionChange)="onSignalToggle(signal.id, $event.detail.checked)">
                            </ion-checkbox>
                            <ion-label>
                              <h3>
                                {{ signal.title }}
                                @if (signal.isExperimental) {
                                  <ion-badge color="warning" class="experimental-badge">Beta</ion-badge>
                                }
                              </h3>
                              <p>{{ signal.description }}</p>
                            </ion-label>
                            <ion-icon
                              name="information-circle-outline"
                              slot="end"
                              color="medium"
                              class="signal-info-icon"
                              (click)="showSignalInfo(signal, $event)">
                            </ion-icon>
                          </ion-item>
                        }
                      } @else {
                        <ion-text color="medium">
                          <p class="ion-padding signal-disabled-hint">Enable the toggle to select hiring signals.</p>
                        </ion-text>
                      }
                    </div>
                  </ion-accordion>
                </ion-accordion-group>
              }

              <!-- Suggestions -->
              <app-suggestions
                [suggestions]="suggestions"
                (applySuggestion)="onApplySuggestion($event)"
                (removeSuggestion)="onRemoveSuggestion($event)">
              </app-suggestions>

              <!-- Action Buttons -->
              <div class="form-actions">
                <ion-button
                  expand="block"
                  color="secondary"
                  (click)="openSavePresetModal()">
                  <ion-icon name="save-outline" slot="start"></ion-icon>
                  Save Preset
                </ion-button>

                <ion-button
                  expand="block"
                  fill="outline"
                  color="medium"
                  (click)="clearForm()">
                  <ion-icon name="trash-outline" slot="start"></ion-icon>
                  Clear All
                </ion-button>

                <!-- Desktop: View Result link (hidden on mobile where sticky bar is used) -->
                @if (booleanQuery && searchUrl) {
                  <ion-button
                    expand="block"
                    fill="clear"
                    color="primary"
                    class="view-result-link ion-hide-lg-down"
                    (click)="scrollToPreview()">
                    View Result
                    <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
                  </ion-button>
                }
              </div>
            </form>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <!-- Preview Column -->
      <ion-col size="12" size-lg="6" class="preview-column">
        <app-preview
          #previewSection
          [booleanQuery]="booleanQuery"
          [searchUrl]="searchUrl"
          [warnings]="warnings"
          [operatorCount]="operatorCount"
          [badgeStatus]="badgeStatus"
          [qualityScore]="qualityScoreResult"
          [platformLabel]="platformRegistry.currentPlatform().label"
          [platformIcon]="platformRegistry.currentPlatform().icon"
          [booleanLevel]="platformRegistry.currentPlatform().getCapabilities().booleanLevel"
          [emotionalMode]="form.get('emotionalMode')?.value || 'normal'"
          [emotionalAdjustments]="emotionalAdjustments"
          [hiringSignalsExplanation]="hiringSignalsExplanation"
          [peopleLocation]="form.get('peopleLocation')?.value"
          [linkedInJobsFilters]="getLinkedInJobsFilters()"
          [postsInjectedPhrases]="postsInjectedPhrases"
          [class.preview-highlight]="showPreviewHighlight"
          (executeSearch)="onExecuteSearch()"
          (shareSearch)="onShareSearch()">
        </app-preview>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>

<!-- Mobile Sticky CTA Bar (visible only on mobile when result exists) -->
@if (booleanQuery && searchUrl) {
  <ion-footer class="mobile-cta-footer ion-hide-lg-up">
    <ion-toolbar>
      <ion-button
        expand="block"
        color="primary"
        (click)="scrollToPreview()"
        class="view-result-btn">
        <ion-icon name="arrow-down-outline" slot="start"></ion-icon>
        View Result
      </ion-button>
    </ion-toolbar>
  </ion-footer>
}
